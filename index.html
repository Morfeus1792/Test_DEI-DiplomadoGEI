<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Configuración de metadatos del documento -->
    <meta charset="UTF-8">
    <!-- Asegura la correcta visualización en dispositivos móviles -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Título de la página que aparece en la pestaña del navegador -->
    <title>Examen final del módulo Diseño de Edificios Inteligentes</title>
    
    <!-- Inclusión de Tailwind CSS para un diseño rápido y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Estilos CSS personalizados -->
    <style>
        /* Importación de la fuente 'Inter' desde Google Fonts para un aspecto moderno */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        /* Aplicación de la fuente a todo el cuerpo del documento */
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Estilo de fondo con un gradiente lineal, usando los colores del sitio de referencia */
        .gradient-bg {
            background: linear-gradient(135deg, #00448D, #002D6C); /* Gradiente con los colores de Innotica */
        }
        
        /* Estilo base para el botón primario */
        .btn-primary {
            background-color: #00448D; /* Color principal de Innotica */
            transition: background-color 0.3s ease; /* Transición suave para el cambio de color */
        }
        
        /* Efecto hover para el botón primario */
        .btn-primary:hover {
            background-color: #003366; /* Tono más oscuro para el hover */
        }
        
        /* Estilo base para el botón secundario */
        .btn-secondary {
            background-color: #6c757d;
            transition: background-color 0.3s ease;
        }
        
        /* Efecto hover para el botón secundario */
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        /* Transición suave para la animación de la barra de progreso */
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
        }
        
        /* Animación del loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00448D;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen">

    <!-- Contenedor principal del examen -->
    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        <!-- Tarjeta principal que contiene todo el contenido -->
        <div id="main-card" class="bg-white rounded-2xl shadow-2xl overflow-hidden">

            <!-- Encabezado del examen -->
            <div id="header" class="gradient-bg p-6 text-white">
                <h1 class="text-2xl sm:text-3xl font-bold">Examen final del módulo Diseño de Edificios Inteligentes</h1>
                <p class="mt-2 text-sm sm:text-base opacity-90">Evaluación final de conocimientos del Módulo 3.</p>
            </div>

            <!-- Área de contenido dinámico que cambiará según la fase del examen -->
            <div id="content-area" class="p-6 sm:p-8">

                <!-- Vista de Inicio: Formulario de datos del estudiante -->
                <div id="start-view">
                    <h2 class="text-xl font-semibold mb-4">Información del Estudiante</h2>
                    <p class="mb-6 text-gray-600">Por favor, completa tus datos para comenzar el examen.</p>
                    <form id="user-info-form">
                        <!-- Campo para el Nombre -->
                        <div class="mb-4">
                            <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                            <input type="text" id="firstName" name="firstName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <!-- Campo para el Apellido -->
                        <div class="mb-4">
                            <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">Apellido</label>
                            <input type="text" id="lastName" name="lastName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <!-- Campo para el Correo Electrónico -->
                        <div class="mb-6">
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label>
                            <input type="email" id="email" name="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <!-- Botón para enviar el formulario y comenzar el examen -->
                        <button type="submit" class="w-full btn-primary text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline">
                            Comenzar Examen
                        </button>
                    </form>
                </div>

                <!-- Vista del Examen: Se muestra durante la resolución de preguntas -->
                <div id="quiz-view" class="hidden">
                    <!-- Cabecera de la pregunta: número de pregunta y temporizador -->
                    <div class="flex justify-between items-center mb-4 flex-wrap">
                        <div class="w-full sm:w-auto mb-2 sm:mb-0">
                            <h2 class="text-xl font-bold">Pregunta <span id="question-number"></span> de <span id="total-questions"></span></h2>
                        </div>
                        <div class="flex items-center bg-gray-200 text-gray-700 text-sm font-semibold px-3 py-1 rounded-full">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <span id="timer">00:00</span>
                        </div>
                    </div>

                    <!-- Barra de progreso del examen -->
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                        <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full progress-bar-fill" style="width: 0%"></div>
                    </div>

                    <!-- Contenedor para el texto de la pregunta y las opciones -->
                    <div id="question-container" class="mb-6">
                        <p id="question-text" class="text-lg mb-6"></p>
                        <div id="options-container" class="space-y-3">
                            <!-- Las opciones de respuesta se generarán dinámicamente aquí -->
                        </div>
                    </div>

                    <!-- Botones de navegación del examen -->
                    <div class="flex justify-between mt-8">
                        <button id="prev-btn" class="btn-secondary text-white font-bold py-2 px-6 rounded-lg">Anterior</button>
                        <button id="next-btn" class="btn-primary text-white font-bold py-2 px-6 rounded-lg">Siguiente</button>
                    </div>
                </div>
                
                <!-- Vista de Evaluación: Se muestra después de finalizar el examen -->
                <div id="evaluating-view" class="hidden text-center">
                    <h2 class="text-2xl font-semibold mb-4">Evaluando tus respuestas...</h2>
                    <p class="mb-6 text-gray-600">Por favor, espera un momento.</p>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div id="eval-progress-bar" class="bg-blue-600 h-4 rounded-full progress-bar-fill" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Vista de Resultados: Muestra la puntuación final y el feedback -->
                <div id="results-view" class="hidden">
                    <h2 class="text-3xl font-bold text-center mb-2">¡Examen Completado!</h2>
                    <p class="text-center text-gray-600 mb-6">Este es el resumen de tu desempeño.</p>
                    
                    <!-- Tarjeta con la puntuación final -->
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-4 rounded-lg mb-8 text-center">
                        <p class="font-bold text-lg">Puntuación Final</p>
                        <p class="text-5xl font-extrabold"><span id="final-score"></span> / <span id="total-score"></span></p>
                    </div>
                    
                    <!-- Contenedor para la revisión y feedback de cada pregunta -->
                    <div id="feedback-container">
                        <h3 class="text-xl font-semibold mb-4">Revisión de Preguntas</h3>
                        <!-- El feedback de cada pregunta se generará dinámicamente aquí -->
                    </div>
                    
                    <!-- Sección final con el estado del envío automático -->
                    <div class="mt-8 text-center">
                         <p id="save-status" class="text-sm font-semibold mt-4"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirmación para finalizar el examen -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full">
            <h3 class="text-xl font-bold mb-4">Confirmar Finalización</h3>
            <p class="text-gray-600 mb-6">¿Estás seguro de que deseas finalizar el examen? No podrás cambiar tus respuestas después de esto.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-finish-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-finish-btn" class="btn-primary text-white font-bold py-2 px-4 rounded-lg">Finalizar y Evaluar</button>
            </div>
        </div>
    </div>


<script>
    // --- Espera a que todo el contenido del DOM esté cargado para ejecutar el script ---
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- BASE DE DATOS DE PREGUNTAS DEL EXAMEN (v4 - Puntuación 50 Verificada) ---
        const questions = [
            { question: "1. Según el documento, ¿cuáles son los cuatro pilares fundamentales de la automatización de edificios?", options: [ "Confort, Energía, Seguridad y Comunicación.", "Arquitectura, Ingeniería, Construcción y Mantenimiento.", "Sensores, Actuadores, Controladores y Software.", "Ahorro, Eficiencia, Innovación y Tecnología." ], correct: 0, points: 2, rationale: "¡Correcto! Estos son los cuatro pilares mencionados directamente en la presentación como las bases de la automatización." },
            { question: "2. ¿Qué tipo de señal es caracterizada por tener solo dos estados, como 'TODO/NADA' o 'NC/NO'?", options: [ "Señal Digital.", "Señal Analógica.", "Señal Proporcional.", "Señal PWM." ], correct: 0, points: 2, rationale: "¡Correcto! La presentación define las señales digitales como de tipo 'TODO/NADA', con ejemplos como Normalmente Cerrado (NC) y Normalmente Abierto (NO)." },
            { question: "3. ¿Cuál es el primer paso a seguir en la metodología de diseño para grandes instalaciones?", options: [ "Definir cada área del proyecto como BMS o RMS.", "Definir el subsistema a diseñar (iluminación, clima, etc.).", "Documentar la memoria descriptiva y los planos.", "Definir la estrategia de control para el subsistema." ], correct: 0, points: 2, rationale: "¡Correcto! La metodología presentada indica que el primer paso es definir y separar las áreas que pertenecerán al BMS (áreas comunes) y al RMS (áreas privadas)." },
            { question: "4. ¿Qué tecnología de comunicación se menciona como un estándar abierto para medianas y grandes instalaciones, regulado por la norma ISO 16484?", options: [ "BACnet.", "KNX.", "LonWorks.", "Modbus." ], correct: 0, points: 2, rationale: "¡Correcto! La presentación lo identifica como un estándar bajo la norma ISO 16484, ideal para grandes instalaciones." },
            { question: "5. En la gestión de un sistema de climatización por agua helada, ¿qué elemento se utiliza para controlar el flujo de agua en las unidades terminales (UMAs)?", options: [ "Válvula proporcional.", "Termostato.", "Sensor de presión.", "Contactor." ], correct: 0, points: 2, rationale: "¡Correcto! En el listado de control para las unidades internas, se especifica una 'Válvula de agua helada del Fancoil' con una señal de control, lo que implica una válvula proporcional." },
            { question: "6. ¿Qué es una 'Pasarela' (Gateway) en el contexto de la integración de sistemas?", options: [ "Un dispositivo que traduce y comunica protocolos diferentes.", "Un software para la visualización de datos (SCADA).", "Un tipo de sensor para medir el consumo eléctrico.", "El controlador principal de todo el edificio (BMS)." ], correct: 0, points: 2, rationale: "¡Correcto! Se describe como una solución para la integración cuando no es nativa, permitiendo que sistemas con protocolos distintos puedan comunicarse." },
            { question: "7. En el ciclo de gestión energética, ¿qué acción sigue inmediatamente después de 'Analizar'?", options: [ "Actuar.", "Medir.", "Supervisar.", "Optimizar." ], correct: 0, points: 2, rationale: "¡Correcto! El diagrama del ciclo de gestión energética muestra claramente que el paso siguiente a 'Analizar' es 'Actuar'." },
            { question: "8. ¿Qué tipo de actuadores son descritos como 'Regulable, Ajustable, Posicionales'?", options: [ "Proporcionales.", "Digitales.", "Analógicos.", "Resistivos." ], correct: 0, points: 2, rationale: "¡Correcto! Esta descripción corresponde a los actuadores proporcionales, que pueden operar en un rango de valores, a diferencia de los de 'TODO/NADA'." },
            { question: "9. ¿Qué actor del mercado es responsable de la 'Ingeniería de detalle para la puesta en marcha'?", options: [ "Integrador.", "Proyectista.", "Promotor.", "Agente de comisionamiento." ], correct: 0, points: 2, rationale: "¡Correcto! En la línea de vida del proyecto, la 'Ingeniería de detalle' es una de las fases posteriores a la contratación, y es una responsabilidad típica del integrador del sistema." },
            { question: "10. En la documentación de un proyecto, ¿cuál es el propósito de una 'Matriz de Responsabilidades'?", options: [ "Definir y delimitar claramente las tareas de cada empresa o especialista involucrado.", "Estimar los costos detallados de los equipos y la mano de obra del proyecto.", "Proporcionar los manuales de operación y mantenimiento.", "Mostrar la ubicación física de los equipos en un plano." ], correct: 0, points: 2, rationale: "¡Correcto! La matriz asigna actividades específicas a las diferentes partes para evitar confusiones." },
            { question: "11. ¿Qué subsistema se encarga del control de equipos como chillers, UMAs y VAVs?", options: [ "Climatización (HVAC).", "Renovación del aire.", "Sistemas sanitarios.", "Control de acceso." ], correct: 0, points: 2, rationale: "¡Correcto! Estos equipos son componentes centrales del sistema de climatización." },
            { question: "12. ¿Cuál es la diferencia principal entre un sistema de climatización VRF/VRV y uno de agua helada?", options: [ "El fluido que utilizan para transportar la energía térmica (refrigerante vs. agua).", "Los sistemas de agua helada no necesitan unidades exteriores.", "Los sistemas VRF/VRV no permiten control individual por zona.", "Los sistemas de agua helada son exclusivamente para edificios pequeños." ], correct: 0, points: 2, rationale: "¡Correcto! Los sistemas VRF usan refrigerante para climatizar, mientras que los sistemas de agua helada usan agua enfriada por un chiller." },
            { question: "13. En la documentación de un proyecto de automatización, ¿qué entregable contiene el listado detallado de todos los puntos de control (entradas/salidas)?", options: [ "Listado de Control y Cómputos.", "Memoria Descriptiva.", "Planos y Diagramas.", "Especificaciones Técnicas." ], correct: 0, points: 2, rationale: "¡Correcto! Este documento contiene la lista detallada de cada punto de control con su tipo y ubicación." },
            { question: "14. ¿Qué tipo de sensor se utiliza para detectar si un ventilador o una bomba está funcionando, midiendo el paso de electricidad?", options: [ "Sensor de corriente.", "Detector de flujo de paleta.", "Detector de presión diferencial.", "Termostato." ], correct: 0, points: 2, rationale: "¡Correcto! Se menciona el uso de sensores de corriente para monitorear el estado (funcionamiento) de bombas y ventiladores." },
            { question: "15. ¿Cuál de las siguientes es una tecnología de comunicación cerrada o propietaria?", options: [ "Lutron.", "BACnet.", "KNX.", "LonWorks." ], correct: 0, points: 3, rationale: "¡Correcto! Lutron es conocido por sus sistemas propietarios, a diferencia de estándares abiertos como BACnet o KNX." },
            { question: "16. ¿Qué es el 'Facility Management'?", options: [ "Una disciplina para asegurar y gestionar el mejor funcionamiento de los inmuebles y sus servicios asociados.", "El proceso de construcción de un nuevo edificio.", "La gestión de un único sistema, como el aire acondicionado.", "El diseño arquitectónico y de interiores de una instalación." ], correct: 0, points: 3, rationale: "¡Correcto! Esta es la definición textual que se proporciona en la presentación, abarcando la integración de personas, espacios y procesos." },
            { question: "17. Dentro de la línea de vida de un proyecto, ¿en qué fase se realiza el 'Comisionamiento de la red'?", options: [ "Obra Construida.", "Pre-diseño.", "Diseño de Arquitectura.", "Construcción de obra." ], correct: 0, points: 3, rationale: "¡Correcto! El comisionamiento es un proceso de aseguramiento de la calidad que verifica que la obra entregada funciona según lo proyectado." },
            { question: "18. En un pasillo largo con múltiples ventanas que reciben abundante luz solar, ¿qué combinación de estrategias de control de iluminación sería la más eficiente?", options: [ "Instalar detectores de presencia y sensores de luminosidad para regular la intensidad.", "Utilizar únicamente una estrategia por horarios.", "Instalar únicamente detectores de presencia.", "Instalar únicamente sensores de luminosidad." ], correct: 0, points: 4, rationale: "¡Correcto! Esta es la solución más completa y eficiente, ya que combina el ahorro por ocupación con el ahorro por aprovechamiento de luz natural (dimming)." },
            { question: "19. Se diseña el control para un quirófano de hospital, donde se exige presión de aire positiva. ¿Qué instrumentación es indispensable para esta estrategia?", options: [ "Un transductor de presión diferencial y un variador de frecuencia (VFD) en la UMA.", "Un termostato de alta precisión y un selector de modo.", "Sensores de CO2 en el quirófano y en el pasillo.", "Un detector de flujo de aire y un contactor para el ventilador." ], correct: 0, points: 4, rationale: "¡Correcto! Se necesita un transductor de presión diferencial para medir la variable clave, y un VFD para regular la velocidad del ventilador y mantener dicha presión." },
            { question: "20. En un listado de control se requiere una 'Tarjeta de comunicación' para cada Chiller. ¿Cuál es el propósito más probable de este componente?", options: [ "Permitir al BMS comunicarse con el chiller vía protocolo para monitorear variables internas sin cableado individual.", "Funcionar como la fuente de alimentación principal para el chiller.", "Permitir al chiller conectarse a internet para descargar actualizaciones.", "Servir como un selector manual para el personal de mantenimiento." ], correct: 0, points: 5, rationale: "¡Correcto! La tarjeta de comunicación permite obtener toda la información interna del equipo a través de un único cable de red, simplificando la instalación." }
        ];
        
        // --- VARIABLES DE ESTADO Y CONFIGURACIÓN ---
        let currentQuestionIndex = 0; // Índice de la pregunta actual.
        let userAnswers = new Array(questions.length).fill(null); // Array para almacenar las respuestas del usuario.
        let userInfo = {}; // Objeto para guardar la información del estudiante.
        let timerInterval; // Variable para el intervalo del temporizador.
        let secondsElapsed = 0; // Contador de segundos transcurridos.
        const totalPoints = questions.reduce((sum, q) => sum + q.points, 0); // Puntuación total posible del examen.
        const gasWebAppUrl = 'https://script.google.com/macros/s/AKfycbwxtLsJ4P1CBjGHxJCbJ5mZQyJS0RIDopEomKEYspEVHuzVCkJIJDmST6y753bu-nuocg/exec';

        // --- REFERENCIAS A ELEMENTOS DEL DOM ---
        const startView = document.getElementById('start-view');
        const quizView = document.getElementById('quiz-view');
        const resultsView = document.getElementById('results-view');
        const evaluatingView = document.getElementById('evaluating-view');
        const confirmModal = document.getElementById('confirm-modal');
        const userInfoForm = document.getElementById('user-info-form');
        const questionNumberEl = document.getElementById('question-number');
        const totalQuestionsEl = document.getElementById('total-questions');
        const progressBar = document.getElementById('progress-bar');
        const questionTextEl = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const timerEl = document.getElementById('timer');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const confirmFinishBtn = document.getElementById('confirm-finish-btn');
        const cancelFinishBtn = document.getElementById('cancel-finish-btn');
        const finalScoreEl = document.getElementById('final-score');
        const totalScoreEl = document.getElementById('total-score');
        const feedbackContainer = document.getElementById('feedback-container');
        const saveStatusEl = document.getElementById('save-status');

        // --- FUNCIONES PRINCIPALES DEL EXAMEN ---

        function startQuiz() {
            userInfo = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value
            };
            startView.classList.add('hidden');
            quizView.classList.remove('hidden');
            startTimer();
            totalQuestionsEl.textContent = questions.length;
            loadQuestion(currentQuestionIndex);
        }

        function loadQuestion(index) {
            const question = questions[index];
            questionNumberEl.textContent = index + 1;
            questionTextEl.innerHTML = `<span class="font-semibold">${question.question}</span> <span class="text-sm font-normal text-gray-500">(${question.points} puntos)</span>`;
            optionsContainer.innerHTML = '';

            question.options.forEach((option, i) => {
                const isChecked = userAnswers[index] === i;
                const optionId = `q${index}_option${i}`;
                const optionElement = document.createElement('label');
                optionElement.htmlFor = optionId;
                optionElement.className = `flex items-center p-4 border rounded-lg cursor-pointer transition-all duration-200 ${isChecked ? 'bg-blue-100 border-blue-500 ring-2 ring-blue-500' : 'border-gray-300 hover:border-blue-400'}`;
                optionElement.innerHTML = `
                    <input type="radio" id="${optionId}" name="question${index}" value="${i}" class="hidden">
                    <span class="w-5 h-5 mr-4 flex-shrink-0 rounded-full border-2 flex items-center justify-center ${isChecked ? 'border-blue-600' : 'border-gray-400'}">
                        ${isChecked ? '<span class="w-2.5 h-2.5 bg-blue-600 rounded-full"></span>' : ''}
                    </span>
                    <span class="text-gray-800">${option}</span>
                `;
                optionElement.addEventListener('click', () => selectAnswer(index, i));
                optionsContainer.appendChild(optionElement);
            });
            updateNavigation();
            updateProgressBar();
        }
        
        function selectAnswer(questionIndex, answerIndex) {
            userAnswers[questionIndex] = answerIndex;
            loadQuestion(questionIndex);
        }

        function updateNavigation() {
            prevBtn.classList.toggle('hidden', currentQuestionIndex === 0);
            if (currentQuestionIndex === questions.length - 1) {
                nextBtn.textContent = 'Finalizar';
            } else {
                nextBtn.textContent = 'Siguiente';
            }
        }

        function updateProgressBar() {
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            progressBar.style.width = `${progress}%`;
        }

        function navigateQuestion(direction) {
            if (direction === 1 && currentQuestionIndex === questions.length - 1) {
                showConfirmationModal();
                return;
            }
            currentQuestionIndex += direction;
            loadQuestion(currentQuestionIndex);
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                secondsElapsed++;
                timerEl.textContent = formatTime(secondsElapsed);
            }, 1000);
        }

        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        function showConfirmationModal() {
            confirmModal.classList.remove('hidden');
        }

        function hideConfirmationModal() {
            confirmModal.classList.add('hidden');
        }

        function finishExam() {
            hideConfirmationModal();
            clearInterval(timerInterval);
            quizView.classList.add('hidden');
            evaluatingView.classList.remove('hidden');
            const evalProgressBar = document.getElementById('eval-progress-bar');
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                evalProgressBar.style.width = `${progress}%`;
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        evaluatingView.classList.add('hidden');
                        calculateAndShowResults();
                    }, 500);
                }
            }, 200);
        }
        
        function calculateScore() {
            return userAnswers.reduce((score, answer, index) => {
                if (answer === questions[index].correct) {
                    return score + questions[index].points;
                }
                return score;
            }, 0);
        }

        function calculateAndShowResults() {
            const score = calculateScore();
            finalScoreEl.textContent = score;
            totalScoreEl.textContent = totalPoints;
            feedbackContainer.innerHTML = '';
            questions.forEach((q, index) => {
                const userAnswerIndex = userAnswers[index];
                const userAnswerText = userAnswerIndex !== null ? q.options[userAnswerIndex] : "No respondida";
                const isCorrect = userAnswerIndex === q.correct;

                const feedbackElement = document.createElement('div');
                feedbackElement.className = `p-4 mb-4 rounded-lg border-l-4 ${isCorrect ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500'}`;
                feedbackElement.innerHTML = `
                    <p class="font-bold text-gray-800">${q.question}</p>
                    <p class="mt-2 text-sm">Tu respuesta: <span class="font-semibold">${userAnswerText}</span></p>
                    ${!isCorrect && userAnswerIndex !== null ? `<p class="mt-1 text-sm">Respuesta correcta: <span class="font-semibold">${q.options[q.correct]}</span></p>` : ''}
                    <p class="mt-2 text-xs text-gray-600">${q.rationale}</p>
                `;
                feedbackContainer.appendChild(feedbackElement);
            });
            
            resultsView.classList.remove('hidden');
            sendDataToWebApp();
        }

        async function sendDataToWebApp() {
            saveStatusEl.textContent = 'Procesando resultados y enviando notificación...';
            saveStatusEl.className = 'text-sm font-semibold mt-4 text-gray-500';

            const payload = {
                sheetName: 'Resultados-ExamenFinal-M3-v1',
                timestamp: new Date().toLocaleString('es-VE', { timeZone: 'America/Caracas' }),
                firstName: userInfo.firstName,
                lastName: userInfo.lastName,
                email: userInfo.email,
                score: calculateScore(),
                totalPoints: totalPoints,
                timeTaken: formatTime(secondsElapsed),
                answers: questions.map((q, i) => ({
                    question: q.question,
                    userAnswer: userAnswers[i] !== null ? q.options[userAnswers[i]] : "No respondida",
                    correctAnswer: q.options[q.correct],
                    isCorrect: userAnswers[i] === q.correct
                }))
            };

            try {
                const response = await fetch(gasWebAppUrl, {
                    method: 'POST',
                    mode: 'no-cors', // Necesario para evitar errores de CORS con Google Apps Script
                    redirect: 'follow',
                    body: JSON.stringify(payload),
                    headers: {
                        "Content-Type": "text/plain;charset=utf-8",
                    }
                });
                
                // Con no-cors no podemos leer la respuesta, así que asumimos éxito si no hay error de red.
                saveStatusEl.textContent = 'Resultados enviados para su procesamiento. Recibirás una notificación por correo.';
                saveStatusEl.className = 'text-sm font-semibold mt-4 text-green-600';

            } catch (error) {
                saveStatusEl.textContent = `Error en el envío automático. Por favor, reporta tu resultado manualmente.`;
                saveStatusEl.className = 'text-sm font-semibold mt-4 text-red-600';
                console.error('Error al enviar datos:', error);
            }
        }

        // --- ASIGNACIÓN DE EVENT LISTENERS ---
        userInfoForm.addEventListener('submit', (e) => {
            e.preventDefault();
            startQuiz();
        });
        prevBtn.addEventListener('click', () => navigateQuestion(-1));
        nextBtn.addEventListener('click', () => navigateQuestion(1));
        confirmFinishBtn.addEventListener('click', finishExam);
        cancelFinishBtn.addEventListener('click', hideConfirmationModal);

    });
</script>

</body>
</html>
